<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚öΩ Football Live Matches</title>
  <style>
    body { font-family: sans-serif; background: #111; color: #eee; margin: 0; padding: 0; }
    header { background: #222; text-align: center; padding: 15px; font-size: 20px; font-weight: bold; }
    .controls { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; padding: 10px; background: #1b1b1b; }
    select, input, button { padding: 6px 10px; border-radius: 6px; border: none; font-size: 14px; }
    button { background: #ffcc00; color: #111; cursor: pointer; font-weight: bold; }
    button:hover { background: #ffd633; }
    #matches { max-width: 1000px; margin: 20px auto; padding: 0 10px; }
    .league-block { margin-bottom: 20px; }
    .league-title { font-weight: bold; font-size: 16px; margin-bottom: 8px; }
    .match { background: #1e1e1e; margin: 10px 0; padding: 12px; border-radius: 8px; }
    .teams { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .team { display: flex; align-items: center; gap: 8px; }
    .team img { width: 28px; height: 28px; border-radius: 4px; }
    .score { font-weight: bold; color: #ffcc00; font-size: 16px; transition: transform 0.3s; }
    .score.pop { transform: scale(1.5); color: orange; }
    .time { color: #aaa; font-size: 13px; }
  </style>
</head>
<body>

<header>‚öΩ Football Live Matches</header>

<div class="controls">
  <label>
    Ligue
    <select id="league">
      <option value="all">üåç Toutes les ligues</option>
    </select>
  </label>
  <label>
    Date
    <input type="date" id="date">
  </label>
  <button id="refresh">üîÑ Actualiser</button>
</div>

<div id="matches"></div>

<audio id="goalSound" src="https://www.soundjay.com/notification/sounds/goal-1.mp3" preload="auto"></audio>

<script>
const API_KEY = "637d4720156cd4c3ed34d17adcd4154e"; // üîë Mets ta cl√© API
const API_URL = "https://v3.football.api-sports.io/fixtures";
const LEAGUE_URL = "https://v3.football.api-sports.io/leagues";
const REFRESH_INTERVAL = 30000;

let matchElements = {};
let previousScores = {};

function localYMD(d = new Date()){
  return d.toISOString().split("T")[0];
}
document.getElementById("date").value = localYMD();

// Notifications
if("Notification" in window && Notification.permission !== "granted"){
  Notification.requestPermission();
}

// Charger toutes les ligues dans le menu
async function loadLeagues(){
  try {
    const res = await fetch(LEAGUE_URL, { headers: { "x-apisports-key": API_KEY } });
    const data = await res.json();
    const select = document.getElementById("league");

    if(data.response && data.response.length){
      data.response.forEach(l => {
        const opt = document.createElement("option");
        opt.value = l.league.id;
        opt.textContent = `${l.league.name} (${l.country.name})`;
        select.appendChild(opt);
      });
    }
  } catch(err){
    console.error("Erreur chargement ligues:", err);
  }
}

// R√©cup√©rer les matchs
async function fetchMatches(date, leagueId){
  const params = new URLSearchParams({ date, season: new Date().getFullYear() });
  if(leagueId && leagueId !== "all") params.set("league", leagueId);
  const url = `${API_URL}?${params.toString()}`;

  const res = await fetch(url, { headers: { "x-apisports-key": API_KEY } });
  if(!res.ok) throw new Error(`API erreur ${res.status}`);
  const data = await res.json();
  return data.response || [];
}

// Affichage notification + son
function showNotification(title, text){
  if(Notification.permission==="granted"){
    new Notification(title, { body: text, icon: "https://upload.wikimedia.org/wikipedia/commons/8/80/Football-icon.png" });
  }
}

// Rendu HTML
function renderMatches(container, fixtures){
  container.innerHTML = "";
  if(fixtures.length === 0){
    container.innerHTML = `<p>Aucun match trouv√© pour cette date.</p>`;
    return;
  }

  const grouped = fixtures.reduce((acc, f) => {
    const key = `${f.league?.name || "?"} (${f.league?.country || "?"})`;
    (acc[key] = acc[key] || []).push(f);
    return acc;
  }, {});

  for(const leagueName in grouped){
    const block = document.createElement("div");
    block.className = "league-block";
    block.innerHTML = `<div class="league-title">${leagueName}</div>`;

    grouped[leagueName].forEach(fix => {
      const id = "match-" + fix.fixture.id;
      let div = matchElements[id];

      const homeName = fix.teams.home.name;
      const awayName = fix.teams.away.name;
      const homeLogo = fix.teams.home.logo || "https://via.placeholder.com/28";
      const awayLogo = fix.teams.away.logo || "https://via.placeholder.com/28";
      const homeScore = fix.goals.home ?? "-";
      const awayScore = fix.goals.away ?? "-";
      const status = fix.fixture.status.elapsed ? 
        `${fix.fixture.status.elapsed}' ‚Ä¢ ${fix.fixture.status.long}` : 
        fix.fixture.status.long;

      if(div){
        const scoreEl = div.querySelector(".score");
        if(scoreEl.textContent !== `${homeScore} - ${awayScore}`){
          scoreEl.textContent = `${homeScore} - ${awayScore}`;
          scoreEl.classList.add("pop");
          setTimeout(()=>{ scoreEl.classList.remove("pop"); }, 500);
          document.getElementById("goalSound").play();
          showNotification("But !", `${homeName} ${homeScore} - ${awayScore} ${awayName}`);
        }
        div.querySelector(".time").textContent = status;
      } else {
        div = document.createElement("div");
        div.className = "match";
        div.id = id;
        div.innerHTML = `
          <div class="teams">
            <div class="team"><img src="${homeLogo}" alt="${homeName}"><span>${homeName}</span></div>
            <div class="score">${homeScore} - ${awayScore}</div>
            <div class="team"><span>${awayName}</span><img src="${awayLogo}" alt="${awayName}"></div>
          </div>
          <div class="time">${status}</div>
        `;
        matchElements[id] = div;
        block.appendChild(div);
      }

      previousScores[id] = `${homeScore} - ${awayScore}`;
    });

    container.appendChild(block);
  }
}

// Charger les matchs
async function loadMatches(){
  const leagueId = document.getElementById("league").value;
  const date = document.getElementById("date").value;
  const container = document.getElementById("matches");
  container.innerHTML = `<p>Chargement...</p>`;

  try {
    const fixtures = await fetchMatches(date, leagueId);
    renderMatches(container, fixtures);
  } catch(err){
    container.innerHTML = `<p>Erreur : ${err.message}</p>`;
    console.error(err);
  }
}

// Events
document.getElementById("refresh").addEventListener("click", loadMatches);
document.getElementById("league").addEventListener("change", loadMatches);
document.getElementById("date").addEventListener("change", loadMatches);

// Auto refresh
setInterval(loadMatches, REFRESH_INTERVAL);

// Initialisation
loadLeagues().then(loadMatches);
</script>

</body>
</html>
